â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  YONA P&L REPORTING SYSTEM - FINAL DEPLOYMENT SUMMARY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ‰ DEPLOYMENT STATUS: LIVE & VERIFIED

URL: https://yona-render-site.onrender.com
Deployment ID: dep-d5nfql14tr6s73d6sp2g
Commit: 782633d (Final code review: Enhanced documentation and comments)
Deployed: January 20, 2026

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  FEATURES IMPLEMENTED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… P&L Dashboard
   - Interactive hierarchy navigation (District, Region, Subsidiary)
   - Searchable/filterable dropdowns
   - Real-time BigQuery integration
   
âœ… Multi-Level District Rendering
   - District summary + individual facility P&Ls
   - Revenue-based filtering (only facilities with Income > 0)
   - Works for both districts and district tags
   
âœ… YTD (Year-to-Date) Reporting
   - Side-by-side Month and YTD columns
   - Actuals vs Budget for both periods
   - Percentage of Income calculations
   
âœ… Account Rollup Logic (CRITICAL FIX)
   - displayExcluded accounts correctly included in parent totals
   - Facilities now show accurate Income values
   - Fixed: Income was showing $0 despite having revenue
   
âœ… Cloud Storage Integration
   - Browse files in dimension_configurations bucket
   - Download configuration files
   - Parse hierarchy configs dynamically
   
âœ… RESTful API for Workflow Automation
   - /api/pl/data - Generate P&L HTML
   - Ready for Zapier, email workflows, scripts
   - Stateless design for easy integration

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  CODE ORGANIZATION & DOCUMENTATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“ Project Structure:
   src/
   â”œâ”€â”€ config/           - GCP & Express configuration
   â”œâ”€â”€ services/         - Business logic layer
   â”‚   â”œâ”€â”€ storageService.js      - Cloud Storage ops
   â”‚   â”œâ”€â”€ bigQueryService.js     - BigQuery queries
   â”‚   â”œâ”€â”€ accountService.js      - Rollup calculations
   â”‚   â””â”€â”€ pnlRenderService.js    - HTML generation
   â”œâ”€â”€ routes/           - API & view endpoints
   â””â”€â”€ app.js            - Application orchestration

ğŸ“š Documentation:
   âœ… README.md                  - Project overview
   âœ… LOCAL_DEVELOPMENT.md       - Setup & dev workflow
   âœ… docs/ARCHITECTURE.md       - System architecture
   âœ… docs/HIERARCHY_SYSTEM.md   - Hierarchy implementation
   âœ… docs/DEVELOPER_GUIDE.md    - Quick reference
   âœ… docs/CRITICAL_CONCEPTS.md  - Key technical concepts (NEW!)
   
ğŸ” Configuration:
   âœ… .env file with GCP_SERVICE_ACCOUNT_KEY & RENDER_API_KEY
   âœ… .gitignore protects sensitive files
   âœ… deploy.sh script for easy deployments

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  API ENDPOINTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Core APIs:
  GET  /api/health               - Health check
  GET  /api/pl/dates             - Available dates
  GET  /api/pl/data              - P&L HTML (Month + YTD)
  
Hierarchy APIs:
  GET  /api/storage/districts    - District hierarchy
  GET  /api/storage/regions      - Region hierarchy
  GET  /api/storage/departments  - Department hierarchy
  
Storage APIs:
  GET  /api/storage/list         - List Cloud Storage files
  GET  /api/storage/download/:f  - Download file

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  CRITICAL TECHNICAL CONCEPTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. Account Rollups
   - displayExcluded = hide from display, NOT from calculations
   - ALWAYS include child values in parent totals
   - Example: "40000 Revenue" rolls into "Income" even if hidden

2. YTD Queries
   - Month: WHERE time_date = @date
   - YTD: WHERE time_date BETWEEN start_of_year AND @date
   - Both queries run for every request

3. Multi-Level Districts
   - 1 summary query (all facilities)
   - N individual queries (one per facility)
   - Filter: Only include if Income > 0

4. Hierarchy Mapping
   - District â†’ customer_internal_id (multiple)
   - Region â†’ region_internal_id (single)
   - Subsidiary â†’ subsidiary_internal_id (single)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  DEPLOYMENT COMMANDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Local Development:
  npm install              # Install dependencies
  npm start                # Start server (http://localhost:3000)
  ./restart.sh             # Kill & restart server

Deployment:
  git add -A               # Stage changes
  git commit -m "..."      # Commit changes
  git push origin main     # Push to GitHub (auto-deploys)
  ./deploy.sh              # Manual deployment with monitoring

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  VERIFICATION RESULTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… Health Check: healthy
âœ… Storage Service: Available
âœ… BigQuery Service: Available
âœ… P&L API Response: 361,447 chars
âœ… YTD Columns: Present (22 headers = 11 reports Ã— 2)
âœ… Multi-Level: District + 10 facilities
âœ… Rollup Logic: Working (facilities show correct Income)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  NEXT STEPS FOR WORKFLOW AUTOMATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

The API is ready for workflow integration!

Example Workflow (Python):
  import requests
  
  response = requests.get(
      'https://yona-render-site.onrender.com/api/pl/data',
      params={
          'hierarchy': 'district',
          'selectedId': '1971',
          'date': '2025-08-01'
      }
  )
  
  html_content = response.json()['html']
  
  # Use HTML in email, PDF, etc.
  send_email(to='user@company.com', html_body=html_content)

Parameters:
  - hierarchy: "district" | "region" | "subsidiary"
  - selectedId: ID from hierarchy dropdowns
  - date: "YYYY-MM-01" format (first day of month)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  REPOSITORY INFORMATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

GitHub: https://github.com/yona-solutions/yona-render-site
Render Dashboard: https://dashboard.render.com/web/srv-d5ndl4pr0fns73fh5b4g

Latest Commits:
  782633d - Final code review: Enhanced documentation
  4a2851b - Add Render API key to .env
  edda53e - Implement YTD data
  263939e - Fix rollup logic for displayExcluded accounts
  8bd6449 - Implement multi-level P&L rendering

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  END OF SUMMARY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
